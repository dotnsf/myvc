<%- include('./header', {}) %>

<title><%= __('index.head.title') %></title>
<script>
$(function(){
<% if ( user.role == 0 ){ %>
  getUsers();
  getItemsForAdmin();
<% }else{ %>
  getItems();
<% } %>
});

function logout(){
  var obj = getBusyOverlay( 'viewport', {color:'black', opacity:0.5, text:'loading', style:'text-decoration:blink; font-weight:bold; font-size:12px; color:white;' } );
  $.ajax({
    type: 'POST',
    url: '/logout',
    data: {},
    success: function( data ){
      obj.remove();
      window.location.href = '/';
    },
    error: function(){
      obj.remove();
      window.location.href = '/';
    }
  });
}

function getUsers(){
  var obj = getBusyOverlay( 'viewport', {color:'black', opacity:0.5, text:'loading', style:'text-decoration:blink; font-weight:bold; font-size:12px; color:white;' } );
  $.ajax({
    type: 'GET',
    url: '/users',
    success: function( users ){
      obj.remove();
      //users = JSON.parse( users );
      //console.log( users );
      users.forEach( user => {
        var tr = "<tr><td>" + user.id + "</td><td>********</td><td>" + user.name + "</td><td>" + user.type + "</td><td> " + abbreviateArray( user.email ) + "</td><td>" + user.role + "</td><td>" + user.created + "</td><td>" + user.loggedin + "</td>";
        tr += "<td><input type='button' class='btn btn-default' value='<%= __('users.buttonlabel.delete') %>' onClick='deleteUser(\"" + user.id + "\")'/></td>";
        tr += "</tr>";
        $('#users_table_tbody').append( tr );
      });
      var tr = "<tr>"
        + "<td><input type='text' id='user_id' placeholder='<%= __('users.placeholder.id') %>'/></td>"
        + "<td><input type='password' id='user_password' placeholder='<%= __('users.placeholder.password') %>'/></td>"
        + "<td><input type='text' id='user_name' placeholder='<%= __('users.placeholder.name') %>'/></td>"
        + "<td><input type='text' id='user_type' placeholder='<%= __('users.placeholder.type') %>'/></td>"
        + "<td><input type='text' id='user_email' placeholder='<%= __('users.placeholder.email') %>'/></td>"
        + "<td><input type='text' id='user_role' placeholder='<%= __('users.placeholder.role') %>' value='1'/></td>"
        + "<td><!-- <input type='text' id='user_created' placeholder='<%= __('users.placeholder.created') %>'/> --> - </td>"
        + "<td><!-- <input type='text' id='user_loggedin' placeholder='<%= __('users.placeholder.loggedin') %>'/> --> - </td>"
        + "<td><input type='button' class='btn btn-default' value='<%= __('users.buttonlabel.add') %>' onClick='addUser();'/></td>"
        + "</tr>"
      $('#users_table_tbody').append( tr );
    },
    error: function( err ){
      obj.remove();
      console.log( err );
    }
  });
}

function addUser(){
  var id = $('#user_id').val();
  var password = $('#user_password').val();
  var name = $('#user_name').val();
  var type = $('#user_type').val();
  var email = $('#user_email').val();
  var role = $('#user_role').val();

  var obj = getBusyOverlay( 'viewport', {color:'black', opacity:0.5, text:'loading', style:'text-decoration:blink; font-weight:bold; font-size:12px; color:white;' } );
  $.ajax({
    type: 'POST',
    url: '/user',
    data: { id: id, password: password, name: name, type: type, email: email, role: role },
    success: function( data ){
      obj.remove();
      window.location.href = '/';
    },
    error: function(){
      obj.remove();
      window.location.href = '/';
    }
  });
}

function deleteUser(id){
  console.log( 'deleteUser(): id=' + id );

  if( window.confirm( '<%= __('users.confirm.delete') %>' + id + ' ?' ) ){
    var obj = getBusyOverlay( 'viewport', {color:'black', opacity:0.5, text:'loading', style:'text-decoration:blink; font-weight:bold; font-size:12px; color:white;' } );
    $.ajax({
      type: 'DELETE',
      url: '/user',
      data: { id: id },
      success: function( data ){
        obj.remove();
        window.location.href = '/';
      },
      error: function(){
        obj.remove();
        window.location.href = '/';
      }
    });
  }
}


function getItemsForAdmin(){
  var obj = getBusyOverlay( 'viewport', {color:'black', opacity:0.5, text:'loading', style:'text-decoration:blink; font-weight:bold; font-size:12px; color:white;' } );
  $.ajax({
    type: 'GET',
    url: '/items',
    success: function( items ){
      obj.remove();
      console.log( items );
      items.forEach( item => {
        var owner_id = '';
        var n = item.owner.indexOf( '#' );
        if( n > -1 ){
          owner_id = item.owner.substring( n + 1, item.owner.length - 1 );
        }
        var tr = "<tr><td>" + item.id + "</td><td>" + item.name + "</td><td>" + item.type + "</td><td>" + item.body + "</td><td>" + item.amount + "</td><td>" + owner_id + "</td><td>" + item.modified + "</td>";
        tr += "</tr>";
        $('#items_table_tbody').append( tr );
      });
    },
    error: function( err ){
      obj.remove();
      console.log( err );
    }
  });
}

function getItems(){
  var obj = getBusyOverlay( 'viewport', {color:'black', opacity:0.5, text:'loading', style:'text-decoration:blink; font-weight:bold; font-size:12px; color:white;' } );
  $.ajax({
    type: 'GET',
    url: '/items',
    success: function( items ){
      obj.remove();
      //console.log( items );

      var max_amount = 0;
      items.forEach( item => {
        if( item.amount > max_amount ){ max_amount = item.amount; }
      });

      var dt = ( new Date() ).getTime() - 120000;
      items.forEach( item => {
        var owner_id = '';
        var n = item.owner.indexOf( '#' );
        if( n > -1 ){
          owner_id = item.owner.substring( n + 1, item.owner.length - 1 );
        }
        var tr = "<tr><td>" + item.id + "</td><td>" + item.name + "</td><td>" + item.type + "</td><td>" + item.body + "</td><td>";

        //tr += item.amount;
        var pct = Math.round( item.amount / max_amount * 100 );
        tr += "<div class='progress'><div class='progress-bar progress-bar-danger";
        if( item.modified.getTime() > dt ){
          tr += " progress-bar-striped active";
        }
        tr += "' role='progressbar' aria-valuenow='" + item.amount + "' aria-valuemin='0' aria-valuemax='" + max_amount + "' style='width:" + pct + "%'>" + item.amount + "</div></div>";

        tr += ( "</td><td>" + owner_id + "</td><td>" + item.modified + "</td>" );
        tr += "<td>"
          + " -&gt; <input type='text' id='new_owner_id_for_" + item.id + "' value='' placeholder='new owner id'/><input type='button' class='btn btn-default' value='<%= __('items.buttonlabel.trade') %>' onClick='tradeItem(" + JSON.stringify(item) + ")'/>"
          + "<br/> -&gt; <input type='text' id='split_owner_id_for_" + item.id + "' value='' placeholder='split owner id'/><input type='text' id='split_amount_for_" + item.id + "' value='' placeholder='split amount'/><input type='button' class='btn btn-default' value='<%= __('items.buttonlabel.split') %>' onClick='splitItem(" + JSON.stringify(item) + ")'/>"
          + "<br/> -&gt; <input type='text' id='merge_target_id_for_" + item.id + "' value='' placeholder='merge target id'/><input type='button' class='btn btn-default' value='<%= __('items.buttonlabel.merge') %>' onClick='mergeItem(" + JSON.stringify(item) + ")'/>"
          + "</td>";
        tr += "</tr>";
        $('#items_table_tbody').append( tr );
      });

      var tr = "<tr>"
      + "<td><input type='text' id='item_id' placeholder='<%= __('items.placeholder.id') %>'/></td>"
      + "<td><input type='text' id='item_name' placeholder='<%= __('items.placeholder.name') %>'/></td>"
      + "<td><!-- <input type='text' id='item_type' placeholder='<%= __('items.placeholder.type') %>'/> --> - </td>"
      + "<td><input type='text' id='item_body' placeholder='<%= __('items.placeholder.body') %>'/></td>"
      + "<td><input type='text' id='item_amount' placeholder='<%= __('items.placeholder.amount') %>'/></td>"
      + "<td><!-- <input type='text' id='item_owner_id' placeholder='<%= __('items.placeholder.owner_id') %>'/> --> - </td>"
      + "<td><!-- <input type='text' id='item_modified' placeholder='<%= __('items.placeholder.modified') %>'/> --> - </td>"
      + "<td><input type='button' class='btn btn-default' value='<%= __('items.buttonlabel.add') %>' onClick='addItem();'/></td>"
      + "</tr>"
      $('#items_table_tbody').append( tr );
    },
    error: function( err ){
      obj.remove();
      console.log( err );
    }
  });
}

function addItem(){
  var id = $('#item_id').val();
  var name = $('#item_name').val();
  var type = $('#item_type').val();
  var body = $('#item_body').val();
  var amount = $('#item_amount').val();
  var owner_id = $('#item_owner_id').val();

  var obj = getBusyOverlay( 'viewport', {color:'black', opacity:0.5, text:'loading', style:'text-decoration:blink; font-weight:bold; font-size:12px; color:white;' } );
  $.ajax({
    type: 'POST',
    url: '/item',
    data: { id: id, name: name, type: type, body: body, amount: amount, owner_id: owner_id },
    success: function( data ){
      obj.remove();
      window.location.href = '/';
    },
    error: function(){
      obj.remove();
      window.location.href = '/';
    }
  });
}

function deleteItem(id){
  console.log( 'deleteItem(): id=' + id );

  if( window.confirm( '<%= __('items.confirm.delete') %>' + id + ' ?' ) ){
    var obj = getBusyOverlay( 'viewport', {color:'black', opacity:0.5, text:'loading', style:'text-decoration:blink; font-weight:bold; font-size:12px; color:white;' } );
    $.ajax({
      type: 'DELETE',
      url: '/item',
      data: { id: id },
      success: function( data ){
        obj.remove();
        window.location.href = '/';
      },
      error: function(){
        obj.remove();
        window.location.href = '/';
      }
    });
  }
}

function editItem( item ){
  $('#item_id').val( item.id );
  $('#item_name').val( item.name );
  $('#item_type').val( item.type );
  $('#item_body').val( item.body );
  $('#item_amount').val( item.amount );
}

function tradeItem( item ){
  if( window.confirm( '<%= __('items.confirm.trade') %>' + item.id + ' ?' ) ){
    var new_owner_id = $('#new_owner_id_for_'+item.id).val();
    var obj = getBusyOverlay( 'viewport', {color:'black', opacity:0.5, text:'loading', style:'text-decoration:blink; font-weight:bold; font-size:12px; color:white;' } );
    $.ajax({
      type: 'POST',
      url: '/trade',
      data: { item_id: item.id, user_id: new_owner_id },
      success: function( data ){
        obj.remove();
        window.location.href = '/';
      },
      error: function(){
        obj.remove();
        window.location.href = '/';
      }
    });
  }
}

function splitItem( item ){
  if( window.confirm( '<%= __('items.confirm.split') %>' + item.id + ' ?' ) ){
    var split_owner_id = $('#split_owner_id_for_'+item.id).val();
    var split_amount = parseInt( $('#split_amount_for_'+item.id).val() );
    var obj = getBusyOverlay( 'viewport', {color:'black', opacity:0.5, text:'loading', style:'text-decoration:blink; font-weight:bold; font-size:12px; color:white;' } );
    $.ajax({
      type: 'POST',
      url: '/split',
      data: { item_id: item.id, user_id: split_owner_id, amount: split_amount },
      success: function( data ){
        obj.remove();
        window.location.href = '/';
      },
      error: function(){
        obj.remove();
        window.location.href = '/';
      }
    });
  }
}

function mergeItem( item ){
  if( window.confirm( '<%= __('items.confirm.merge') %>' + item.id + ' ?' ) ){
    var merge_target_id = $('#merge_target_id_for_'+item.id).val();
    var obj = getBusyOverlay( 'viewport', {color:'black', opacity:0.5, text:'loading', style:'text-decoration:blink; font-weight:bold; font-size:12px; color:white;' } );
    $.ajax({
      type: 'POST',
      url: '/merge',
      data: { item1_id: item.id, item2_id: item.id },
      success: function( data ){
        obj.remove();
        window.location.href = '/';
      },
      error: function(){
        obj.remove();
        window.location.href = '/';
      }
    });
  }
}
</script>
<style>
html, body, {
  background-color: #ddddff;
  height: 100%;
  margin: 0px;
  padding: 0px
}
</style>
</head>
<body>

<%- include('./nav', {}) %>

<% if( user.role == 0 ){ %>

<div class="container-fluid" style="padding:20px 0; font-size:8px;">
  <table class="table table-hover table-bordered" id="users_table">
    <thead class="table-inverse">
      <tr>
        <tr><th bgcolor="#ddddff" colspan="9"><%= __('users.table.title') %></th></tr>
        <th><%= __('users.table.id') %></th>
        <th><%= __('users.table.password') %></th>
        <th><%= __('users.table.name') %></th>
        <th><%= __('users.table.type') %></th>
        <th><%= __('users.table.email') %></th>
        <th><%= __('users.table.role') %></th>
        <th><%= __('users.table.created') %></th>
        <th><%= __('users.table.loggedin') %></th>
        <th><%= __('users.table.action') %></th>
      </tr>
    </thead>
    <tbody id="users_table_tbody">
    </tbody>
  </table>
</div>

<hr/>

<div class="container-fluid" style="padding:20px 0; font-size:8px;">
  <table class="table table-hover table-bordered" id="items_table">
    <thead class="table-inverse">
      <tr>
        <tr><th bgcolor="#ddddff" colspan="7"</th></tr>
        <th><%= __('items.table.id') %></th>
        <th><%= __('items.table.name') %></th>
        <th><%= __('items.table.type') %></th>
        <th><%= __('items.table.body') %></th>
        <th><%= __('items.table.amount') %></th>
        <th><%= __('items.table.owner') %></th>
        <th><%= __('items.table.modified') %></th>
      </tr>
    </thead>
    <tbody id="items_table_tbody">
    </tbody>
  </table>
</div>

<% }else{ %>

<div class="container-fluid" style="padding:20px 0; font-size:8px;">
  <table class="table table-hover table-bordered" id="items_table">
    <thead class="table-inverse">
      <tr>
        <tr><th bgcolor="#ddddff" colspan="8"><%= __('items.table.title') %></th></tr>
        <th><%= __('items.table.id') %></th>
        <th><%= __('items.table.name') %></th>
        <th><%= __('items.table.type') %></th>
        <th><%= __('items.table.body') %></th>
        <th><%= __('items.table.amount') %></th>
        <th><%= __('items.table.owner') %></th>
        <th><%= __('items.table.modified') %></th>
        <th><%= __('items.table.action') %></th>
      </tr>
    </thead>
    <tbody id="items_table_tbody">
    </tbody>
  </table>
</div>

<% } %>

<%- include('./footer', {}) %>
